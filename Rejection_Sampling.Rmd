---
title: "Rejection Sampling-Gamma"
author: "Jingjing Guo"
date: "November 14, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Generate gamma random variable via rejection sampling
### Unit Uniform to Exponential with $\lambda$:
```{r}
lambda <- 1
x <- runif(1000)
y <- -1/lambda *log(1-x)
hist(y)
```

The inverse-cdf method:
The CDF of a random variable, X, is denoted as F(x), and $U \sim UNIF(0,1)$, then X can be generated by:
\begin{align*}
X = F^{-1}(U)
\end{align*}
Proof:
The CDF of a random variable, X, is defined as: F(X) = $Pr(X \leq x)$
Assume random variable Y is a function of X, i.e. $Y = g(X)$ then $X = g^{-1}(Y)$, therefore

\begin{align*}
Pr(X \leq x) = Pr( g^{-1} (Y) \leq x)
\end{align*}
Note the event $g^{-1} (Y) \leq x$ is equivalent to $g ( g^{-1} (Y) )  \leq g(x)$ that is 
\begin{align*}
Pr( g^{-1} (Y) \leq x) &= Pr\{ g(g^{-1} (Y)) \leq g(x) \} \\ &= Pr\{ Y \leq g(x) \}
\end{align*}

For unit uniform distributions $Pr(Y \leq y) = y$ and so if $Y \sim UNIF(0,1)$, then
\begin{align*}
Pr(X \leq x) &= Pr( g^{-1} (Y) \leq x)  \\ &= Pr\{ g(g^{-1} (Y)) \leq g(x) \} \\ &= Pr\{ Y \leq g(x) \} \\ &= g(x)
\end{align*}

Therefore $y = g(x) = F(x)$, $x = F^{-1}(y)$, where $y \sim UNIF(0,1)$


### Truncated Pareto distribution:
#### normalization constants:
$K = 1- a$

\begin{align*}
	1 &= \int_0^1 P(Y=y) dy = \int_0^1 K \frac{1}{y^a} dy = \left. \frac{K}{1-a} y^{1-a} \right \rvert_0^1 =  \frac{K}{1-a}\\
	1 &= \frac{K}{1-a}
\end{align*}
therefore the normalizing constant is $K = 1-a$. 

#### inverse-cdf method to generate Y by transforming U:
Probability density function of Y is:
\begin{align*}
	Y = f(y) &= K \frac{1}{y^a} = (1-a) \frac{1}{y^a} \\
\end{align*}
Cumulative density function of Y is then:
\begin{align*}
	F(y) &= \int_0^y (1-a) \frac{1}{y^a} dy = y^{1-a}\\
	Y &= F^{-1}(U) = U^{(a-1)}
\end{align*}

### Density function of a Gamma random variable, $p_{Gamma}(x \vert \alpha, \beta)$
A Gamma random variable with shape parameter $\alpha$ and rate parameter $\beta$ has density 
\begin{align*}
p_{Gamma}(x|\alpha,\beta) = \frac{\beta^{\alpha}x^{\alpha-1}e^{-\beta x}}{\Gamma(\alpha)},\quad x> 0,
\end{align*}
where $\Gamma$ is the Gamma function. 

### sample Gamma with (alpha_int, 1), where alpha_int must be an integer.
The sum of two independent exponential random variables with $\lambda =1$ has a Gamma distribution with $\alpha=2$ and $\beta = 1$. More generally, the sum of $\alpha_{int}$ independent exponential random variables with $\lambda=1$ has a Gamma distribution with $\alpha=\alpha_{int}$ and $\beta=1$. The algorithm is therefore: 
\begin{itemize}
	\item[(i)] {Generate} independent $U_i\sim U(0,1)$, $i=1,\dots,\alpha_{int}$
	\item[(ii)] Set $Y_i=-\ln(1-U_i)$, $i=1,\dots,\alpha_{int}$
	\item[(iii)] Return $X = Y_1+\dots + Y_{\alpha_{int}}$
\end{itemize}

### alpha < 1

### $C_1$ and $C_2$:
 Let $\alpha<1$. For $0< x\leq 1$ we use $e^{-x}\leq 1$ for $x\geq 0$ to write
\begin{align*}
p_{Gamma}(x|\alpha,1)
=\frac{x^{\alpha-1}e^{-x}}{\Gamma(\alpha)}
\leq C_1 x^{\alpha-1},\quad 0< x\leq 1,
\end{align*}
where $C_1=1/\Gamma(\alpha)$. For $x\geq 1$ we use $x^{\alpha-1}\leq 1$ to write 
\begin{align*}
p_{Gamma}(x|\alpha,1)
=\frac{x^{\alpha-1}e^{-x}}{\Gamma(\alpha)}
\leq C_2 e^{-x},\quad x\geq 1,
\end{align*}
where $C_2 = 1/\Gamma(\alpha)$. 

### pdf $q(x|a)$ and a scalar M such that $p_{Gamma}(x \vert \alpha, 1) \leq M \cdot q(x \vert \alpha)$
We will take $q(x|\alpha)$ to be a combination of a Pareto density with $a=1-\alpha$ for $0<x\leq 1$, and an Exponential density with $\lambda=1$ for $x\geq 1$:
\begin{align*}
q(x|\alpha) = p_1 \times \alpha x^{\alpha-1}{\bf 1}_{\{0< x\leq 1\}} + p_2\times e^{-x},
\end{align*} 
and we need to choose the weights $p_1$ and $p_2$ so that $q(x|\alpha)$ is a valid density, and we will use the upper bounds in Part 5 above to do that. Note that 
\begin{align*}
\int_0^1C_1x^{\alpha-1}dx &= \frac{C_1}{\alpha}
\quad \text{ and } \quad \int_1^{\infty}C_2e^{-x}dx = \frac{C_2}{e},
\end{align*}
and we will propose (using that $C_1=C_2$)
\begin{align*}
p_1 = \frac{C_1/\alpha}{C_1/\alpha + C_2/e} &= \frac{1/\alpha}{1/\alpha+1/e} = \frac{e}{e+\alpha}\\
p_2 = \frac{C_2/e}{C_1/\alpha + C_2/e} &= \frac{\alpha}{e+\alpha},
\end{align*}
so
\begin{align*}
q(x|\alpha) = \frac{e}{e+\alpha} \times \alpha x^{\alpha-1}{\bf 1}_{\{0< x\leq 1\}} + \frac{\alpha}{e+\alpha}\times e^{-x},
\end{align*} 
which is positive and integrates to one:
\begin{align*}
\int_0^{\infty}\Big(\frac{e}{e+\alpha} \times \alpha x^{\alpha-1}{\bf 1}_{\{0< x\leq 1\}} + \frac{\alpha}{e+\alpha}\times e^{-x}\Big)dx
&=\frac{e}{e+\alpha}\int_0^{1}\alpha x^{\alpha-1}dx + \frac{\alpha}{e+\alpha}\int_0^{\infty} e^{-x}dx\\
&=\frac{e}{e+\alpha} + \frac{\alpha}{e+\alpha}\\
&=1,
\end{align*} 
and is therefore a valid density. Finally, given the bounds for $p_{Gamma}$ in Part 5, and since
\begin{align*}
q(x|\alpha) = \Big(\frac{e\alpha}{e+\alpha}\times  x^{\alpha-1}+\frac{\alpha}{e+\alpha}\times e^{-x}\Big){\bf 1}_{\{0< x\leq 1\}} + \frac{\alpha}{e+\alpha}\times e^{-x}{\bf 1}_{\{x\geq 1\}},
\end{align*} 
it is sufficient to take the constant $M$ such that
\begin{align*}
M \frac{e\alpha}{e+\alpha} \geq C_1
\quad\text{and}\quad M\frac{\alpha}{e+\alpha} \geq C_2
 \quad\Longrightarrow \quad M \geq \max\Big\{ C_1\frac{e+\alpha}{e\alpha },C_2\frac{e+\alpha}{\alpha}\Big\},
\end{align*}
and since $e>1$ and $C_1=C_2=1/\Gamma(\alpha)$ we take
\begin{align*}
M =\frac{e+\alpha}{\alpha \Gamma(\alpha)}.
\end{align*}

### pseudocode for rejection sampler from $p_{Gamma}(x \vert \alpha, 1)$ and acceptance probability:

First we describe how to generate from the distribution with density $q$: 
\begin{itemize}
	\item[(i)] {Generate} a Bernoulli (zero-one) random variable $Y$ with success probability $p=e/(e+\alpha)$, and an independent uniform random variable $U\sim U(0,1)$. 
	\item[(ii)] If $Y=1$, use $U$ and Part 2 to generate a Pareto random variable $X$. If $Y=0$, use $U$ and Part 1 to generate an exponential random variable $X$.
	\item[(iii)] Return $X$. 
\end{itemize}
Now we describe how to generate from the Gamma distribution:
\begin{itemize}
	\item[(i)] Generate a uniform random variable $U\sim U(0,1)$ and a random variable $X$ from the density $q$ as described above.
	\item[(ii)] If 
	\begin{align*} 
	U\leq \frac{p_{Gamma}(X|\alpha,1)}{Mq(X|\alpha)},
	\end{align*} 
	then return $X$. Otherwise, go back to step (i). 
\end{itemize}

### Generate a Gamma with arbitrary shape parameter, and rate equal to one:
Independent Gamma random variables with the same rate parameter have the property that the shape parameter $\alpha$ is ``additive''. We already used this in Part 4 when generating from $Gamma(\alpha_{int},1)$. In part 5 we then generated from $Gamma(\alpha,1)$ with $0<\alpha<1$. 

We then have the following procedure to generate from $Gamma(\alpha,1)$ for a general shape parameter $\alpha$:
\begin{itemize}
	\item[(i)] Use Part 4 to generate $X_1$ from $Gamma(\alpha_{int},1)$ where $\alpha_{int}$ is the integer part of $\alpha$ (smallest integer below it). 
	\item[(ii)] Use Part 5 to generate $X_2$ from $Gamma(\alpha-\alpha_{int},1)$.
	\item[(iii)] Return $X=X_1+X_2$.
\end{itemize}

Finally, to generate from $Gamma(\alpha,\beta)$ with arbitrary rate parameter $\beta$, we use the scaling property of the Gamma distribution: 
\begin{align*}
X\sim Gamma(\alpha,\beta)
\quad \Rightarrow \quad 
c X \sim Gamma(\alpha,c\beta).
\end{align*}

The algorithm to generate from $Gamma(\alpha,\beta)$ is therefore:

1) Generate $X\sim Gamma(\alpha,1)$.

2) Return $\beta X$. 

